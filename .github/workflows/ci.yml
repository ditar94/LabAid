name: CI â€” PR Checks

on:
  pull_request:
    branches: [main, beta]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Check Python dependencies for vulnerabilities
        run: |
          pip install pip-audit
          echo "Scanning Python dependencies for vulnerabilities..."
          pip-audit --strict --vulnerability-service osv || {
            echo "::warning::Python dependency vulnerabilities found. Review and update requirements.txt"
            pip-audit --vulnerability-service osv
          }

      - name: Check for destructive migrations
        run: |
          cd alembic/versions

          # Dangerous SQL patterns that could cause data loss
          DANGEROUS_PATTERNS="DROP COLUMN|DROP TABLE|DROP INDEX|ALTER COLUMN.*TYPE|RENAME COLUMN|TRUNCATE"

          # Check all migration files
          FOUND_DANGEROUS=""
          for file in *.py; do
            [ -f "$file" ] || continue

            # Look for dangerous operations (case-insensitive)
            MATCHES=$(grep -iE "$DANGEROUS_PATTERNS" "$file" 2>/dev/null | grep -v "^#" | grep -v "# DESTRUCTIVE:" || true)

            if [ -n "$MATCHES" ]; then
              # Check if there's an acknowledgment comment
              if ! grep -q "# DESTRUCTIVE: acknowledged" "$file"; then
                FOUND_DANGEROUS="$FOUND_DANGEROUS

          FILE: $file
          $MATCHES"
              fi
            fi
          done

          if [ -n "$FOUND_DANGEROUS" ]; then
            echo ""
            echo "::error::Destructive migration operations detected!"
            echo "$FOUND_DANGEROUS"
            echo ""
            echo "These operations can cause DATA LOSS in production."
            echo ""
            echo "If intentional, add this comment to the migration file:"
            echo "  # DESTRUCTIVE: acknowledged - [reason for data loss]"
            echo ""
            exit 1
          fi

          echo "No unacknowledged destructive migrations found."

      - name: Validate migrations against Postgres
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          SECRET_KEY: test-secret-key
        run: |
          echo "Running alembic migrations..."
          alembic upgrade head

      - name: Check for missing migrations
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          SECRET_KEY: test-secret-key
        run: |
          echo "Checking if models match migrations..."
          if ! alembic check 2>&1 | grep -q "No new upgrade operations detected"; then
            echo ""
            echo "::error::Models have changed but no migration was created!"
            echo ""
            echo "Run locally:"
            echo "  cd backend && alembic revision --autogenerate -m 'description'"
            echo ""
            echo "Then commit the new migration file and push again."
            exit 1
          fi
          echo "Models and migrations are in sync."

      - name: Test migration rollback
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          SECRET_KEY: test-secret-key
        run: |
          echo "Testing migration downgrade..."
          alembic downgrade -1 || { echo "::error::Migration downgrade failed! Ensure downgrade() is implemented."; exit 1; }
          echo "Testing migration upgrade again..."
          alembic upgrade head || { echo "::error::Migration upgrade after downgrade failed!"; exit 1; }
          echo "Migration rollback test passed."

      - name: Verify models load correctly
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test
          SECRET_KEY: test-secret-key
        run: |
          python -c "
          from app.models import *
          from app.main import app
          print('All models and routes loaded successfully')
          "

      - name: Run tests
        env:
          SECRET_KEY: test-secret-key
          DATABASE_URL: postgresql://test:test@localhost:5432/test
        run: python -m pytest tests/ -v

  frontend-typecheck:
    name: Frontend Typecheck
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check Node dependencies for vulnerabilities
        run: |
          echo "Scanning Node dependencies for vulnerabilities..."
          npm audit --audit-level=high || {
            echo "::warning::Node dependency vulnerabilities found. Run 'npm audit fix' to resolve."
          }

      - name: TypeScript check
        run: npx tsc --noEmit -p tsconfig.app.json

  terraform-validate:
    name: Terraform Safety Check
    if: contains(github.event.pull_request.title, 'terraform') || contains(github.event.pull_request.title, 'infra')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    defaults:
      run:
        working-directory: terraform
    steps:
      - uses: actions/checkout@v6

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.5"

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Terraform init
        run: terraform init -backend=false

      - name: Terraform validate
        run: terraform validate

      - name: Terraform plan (beta)
        id: plan
        run: |
          terraform plan \
            -var-file=environments/beta.tfvars \
            -out=tfplan.binary \
            -detailed-exitcode \
            || true
          terraform show -json tfplan.binary > tfplan.json

      - name: Check for destructive actions on stateful resources
        run: |
          PROTECTED_TYPES='["google_sql_database_instance", "google_sql_database", "google_sql_user", "google_storage_bucket"]'

          DESTROYS=$(python3 -c "
          import json
          with open('tfplan.json') as f:
              plan = json.load(f)
          protected = json.loads('$PROTECTED_TYPES')
          found = []
          for c in plan.get('resource_changes', []):
              if c.get('type') in protected:
                  actions = c.get('change', {}).get('actions', [])
                  if 'delete' in actions:
                      found.append(f\"  DESTROY: {c['address']} (actions: {'+'.join(actions)})\")
          if found:
              print('BLOCKED')
              for line in found:
                  print(line)
          " 2>/dev/null || true)

          if echo "$DESTROYS" | grep -q "^BLOCKED"; then
            echo ""
            echo "::error::Terraform plan would DESTROY protected stateful resources!"
            echo ""
            echo "$DESTROYS"
            echo ""
            echo "If you renamed a resource key, use: terraform state mv OLD NEW"
            echo "See docs/DISASTER_RECOVERY.md for Terraform safety rules."
            exit 1
          fi

          echo "No destructive actions on protected resources."
