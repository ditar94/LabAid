"""PDF rendering for compliance reports using fpdf2."""

from datetime import datetime, timezone

from fpdf import FPDF


class LabAidPDF(FPDF):
    """Base PDF class with branded header and footer."""

    def __init__(self, title: str, lab_name: str):
        super().__init__(orientation="L", unit="mm", format="A4")
        self.report_title = title
        self.lab_name = lab_name
        self.generated_at = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M UTC")
        self.set_auto_page_break(auto=True, margin=20)

    def header(self):
        self.set_font("Helvetica", "B", 14)
        self.cell(0, 8, self.report_title, new_x="LMARGIN", new_y="NEXT")
        self.set_font("Helvetica", "", 9)
        self.set_text_color(100, 100, 100)
        self.cell(0, 5, f"Lab: {self.lab_name}  |  Generated: {self.generated_at}", new_x="LMARGIN", new_y="NEXT")
        self.set_text_color(0, 0, 0)
        self.ln(3)

    def footer(self):
        self.set_y(-15)
        self.set_font("Helvetica", "I", 8)
        self.set_text_color(130, 130, 130)
        self.cell(0, 10, f"Page {self.page_no()}/{{nb}}  —  Electronically generated by LabAid. Do not alter.", align="C")

    def _table_header(self, columns: list[tuple[str, int]]):
        self.set_font("Helvetica", "B", 8)
        self.set_fill_color(240, 240, 245)
        for col_name, col_width in columns:
            self.cell(col_width, 7, col_name, border=1, fill=True)
        self.ln()

    def _table_row(self, values: list[str], widths: list[int]):
        self.set_font("Helvetica", "", 7)
        max_h = 7
        # Calculate needed height for multi-line cells
        line_heights = []
        for val, w in zip(values, widths):
            # Approximate number of lines needed
            text_w = self.get_string_width(val)
            lines = max(1, int(text_w / (w - 2)) + 1)
            line_heights.append(lines * 4)
        row_h = max(max_h, max(line_heights))

        # Check if we need a page break
        if self.get_y() + row_h > self.h - 20:
            self.add_page()

        y_start = self.get_y()
        x_start = self.get_x()
        for i, (val, w) in enumerate(zip(values, widths)):
            x = x_start + sum(widths[:i])
            self.set_xy(x, y_start)
            self.multi_cell(w, 4, val, border=1, new_x="RIGHT", new_y="TOP", max_line_height=row_h)
        self.set_y(y_start + row_h)


def render_audit_trail_pdf(data: list[dict], lab_name: str) -> bytes:
    pdf = LabAidPDF("Audit Trail Report", lab_name)
    pdf.alias_nb_pages()
    pdf.add_page()

    columns = [
        ("Timestamp", 42),
        ("User", 35),
        ("Action", 35),
        ("Entity Type", 25),
        ("Entity", 70),
        ("Note", 55),
        ("Support", 15),
    ]

    pdf._table_header(columns)
    widths = [c[1] for c in columns]

    for row in data:
        pdf._table_row(
            [row["timestamp"][:19], row["user"], row["action"],
             row["entity_type"], row["entity"], row["note"], row["support"]],
            widths,
        )

    return pdf.output()


def render_lot_lifecycle_pdf(data: list[dict], lab_name: str) -> bytes:
    pdf = LabAidPDF("Lot Lifecycle Report", lab_name)
    pdf.alias_nb_pages()
    pdf.add_page()

    for lot in data:
        # Lot header
        pdf.set_font("Helvetica", "B", 10)
        pdf.cell(0, 7, f"Lot {lot['lot_number']} — {lot['antibody']}", new_x="LMARGIN", new_y="NEXT")
        pdf.set_font("Helvetica", "", 8)
        status_parts = [
            f"QC: {lot['qc_status']}",
            f"Expires: {lot['expiration_date'] or 'N/A'}",
            f"Created: {lot['created_at'][:10]}",
            f"Vials: {lot['total_vials']} (S:{lot['sealed']} O:{lot['opened']} D:{lot['depleted']})",
        ]
        if lot["is_archived"]:
            status_parts.append("ARCHIVED")
        pdf.cell(0, 5, "  |  ".join(status_parts), new_x="LMARGIN", new_y="NEXT")
        pdf.ln(2)

        # Events table
        if lot["events"]:
            columns = [
                ("Timestamp", 42),
                ("Action", 45),
                ("User", 45),
                ("Note", 110),
                ("Support", 15),
            ]
            pdf._table_header(columns)
            widths = [c[1] for c in columns]
            for ev in lot["events"]:
                pdf._table_row(
                    [ev["timestamp"][:19], ev["action"], ev["user"], ev["note"], ev["support"]],
                    widths,
                )
        else:
            pdf.set_font("Helvetica", "I", 8)
            pdf.cell(0, 5, "No audit events recorded.", new_x="LMARGIN", new_y="NEXT")

        pdf.ln(5)

    return pdf.output()


def render_qc_history_pdf(data: list[dict], lab_name: str) -> bytes:
    pdf = LabAidPDF("QC History Report", lab_name)
    pdf.alias_nb_pages()
    pdf.add_page()

    columns = [
        ("Timestamp", 42),
        ("Lot", 30),
        ("Antibody", 40),
        ("Action", 35),
        ("User", 35),
        ("Entity", 50),
        ("Note", 35),
        ("Support", 15),
    ]

    pdf._table_header(columns)
    widths = [c[1] for c in columns]

    for row in data:
        pdf._table_row(
            [row["timestamp"][:19], row["lot_number"], row["antibody"],
             row["action"], row["user"], row["entity"], row["note"], row["support"]],
            widths,
        )

    return pdf.output()


def render_qc_verification_pdf(data: dict, lab_name: str) -> bytes:
    pdf = LabAidPDF("QC Verification Dossier", lab_name)
    pdf.alias_nb_pages()
    pdf.add_page()

    # Lot information header
    pdf.set_font("Helvetica", "B", 12)
    pdf.cell(0, 8, f"Lot {data['lot_number']}", new_x="LMARGIN", new_y="NEXT")
    pdf.set_font("Helvetica", "", 9)

    info_lines = [
        f"Antibody: {data['antibody']}",
        f"Vendor: {data['vendor']}  |  Catalog: {data['catalog_number']}",
        f"Expiration: {data['expiration_date'] or 'N/A'}",
        f"QC Status: {data['qc_status'].upper()}" + (f"  —  Approved by: {data['qc_approved_by']}" if data['qc_approved_by'] else ""),
        f"QC Approved At: {data['qc_approved_at'][:19] if data['qc_approved_at'] else 'N/A'}",
        f"Created: {data['created_at'][:10]}  |  Archived: {'Yes' if data['is_archived'] else 'No'}",
    ]
    for line in info_lines:
        pdf.cell(0, 5, line, new_x="LMARGIN", new_y="NEXT")
    pdf.ln(5)

    # Documents section
    pdf.set_font("Helvetica", "B", 10)
    pdf.cell(0, 7, "Attached Documents", new_x="LMARGIN", new_y="NEXT")

    if data["documents"]:
        doc_cols = [
            ("File Name", 70),
            ("QC Document", 25),
            ("Description", 80),
            ("Uploaded By", 45),
            ("Uploaded At", 42),
        ]
        pdf._table_header(doc_cols)
        doc_widths = [c[1] for c in doc_cols]
        for doc in data["documents"]:
            pdf._table_row(
                [doc["file_name"], "Yes" if doc["is_qc_document"] else "No",
                 doc["description"], doc["uploaded_by"], doc["uploaded_at"][:19] if doc["uploaded_at"] else ""],
                doc_widths,
            )
    else:
        pdf.set_font("Helvetica", "I", 8)
        pdf.cell(0, 5, "No documents attached.", new_x="LMARGIN", new_y="NEXT")

    pdf.ln(5)

    # QC History section
    pdf.set_font("Helvetica", "B", 10)
    pdf.cell(0, 7, "QC History", new_x="LMARGIN", new_y="NEXT")

    if data["qc_history"]:
        qc_cols = [
            ("Timestamp", 42),
            ("Action", 45),
            ("User", 45),
            ("Note", 110),
            ("Support", 15),
        ]
        pdf._table_header(qc_cols)
        qc_widths = [c[1] for c in qc_cols]
        for ev in data["qc_history"]:
            pdf._table_row(
                [ev["timestamp"][:19], ev["action"], ev["user"], ev["note"], ev["support"]],
                qc_widths,
            )
    else:
        pdf.set_font("Helvetica", "I", 8)
        pdf.cell(0, 5, "No QC events recorded.", new_x="LMARGIN", new_y="NEXT")

    pdf.ln(5)

    # Full audit trail
    pdf.set_font("Helvetica", "B", 10)
    pdf.cell(0, 7, "Complete Audit Trail", new_x="LMARGIN", new_y="NEXT")

    if data["full_audit_trail"]:
        trail_cols = [
            ("Timestamp", 42),
            ("Action", 45),
            ("User", 45),
            ("Note", 110),
            ("Support", 15),
        ]
        pdf._table_header(trail_cols)
        trail_widths = [c[1] for c in trail_cols]
        for ev in data["full_audit_trail"]:
            pdf._table_row(
                [ev["timestamp"][:19], ev["action"], ev["user"], ev["note"], ev["support"]],
                trail_widths,
            )
    else:
        pdf.set_font("Helvetica", "I", 8)
        pdf.cell(0, 5, "No audit events recorded.", new_x="LMARGIN", new_y="NEXT")

    return pdf.output()
